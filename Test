--create or replace MATERIALIZED view SC_LOG.INT_WMS.V_TD_GBL_SC_WMS_WAREHOUSE_TASK_KPI_2(
CREATE DYNAMIC TABLE SC_LOG.INT_WMS.T_TD_GBL_SC_WMS_WAREHOUSE_TASK_KPI_2
WAREHOUSE = SC_BI_WH
TARGET_LAG = '1 minute'
AS
(
WITH SHIFT_BASE AS (
  SELECT 
  PA_FROM AS LGNUM,
  SRC_SYS,
  PA_TO AS SHIFT_START_RAW,
  CASE 
      WHEN ZCOMMENT = 'UTC-7' THEN 'America/Denver'
      WHEN ZCOMMENT = 'UTC-6' THEN 'America/Chicago'
      WHEN ZCOMMENT = 'UTC-5' THEN 'America/New_York'
  ELSE ZCOMMENT
END AS TIMEZONE
FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
WHERE PROCESS = 'WMS' AND CATE = 'SHIFT_HR'
),
SHIFT_PARAMS AS (
  SELECT LGNUM, SRC_SYS, SHIFT_START_RAW, TIMEZONE, 'DAY' AS SHIFT_TYPE
  FROM SHIFT_BASE
  UNION ALL
  SELECT
    LGNUM,
    SRC_SYS,
    TO_CHAR(TIMEADD('HOUR', 12, TO_TIME(SHIFT_START_RAW)), 'HH24:MI') AS SHIFT_START_RAW,
    TIMEZONE,
    'NIGHT' AS SHIFT_TYPE
  FROM SHIFT_BASE
),
INDIRECT_PARAMS AS (
  SELECT PA_FROM AS LGNUM, SRC_SYS, TO_NUMBER(PA_TO,10,1) AS MAX_TASK_DURATION
  FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
  WHERE PROCESS = 'WMS' AND CATE = 'IND_TIME'
),

-- NLTYP mapping to reproduce the filter used in the MRR KPI query (warehouse + destination storage type)
NLTYP_PARAMS AS (
  SELECT
    PA_FROM AS LGNUM,
    PA_TO   AS NLTYP,
    SRC_SYS
  FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
  WHERE PROCESS = 'WMS' AND CATE = 'NLTYP' AND SRC_SYS = 'NA'
),

BASE AS (
  SELECT
    'NA' AS CC_SOURCE_SYSTEM,
    LGNUM, TANUM, TAPOS, PROCTY, TRART, DOCCAT, REASON,
    GUID_STOCK, LETYP, VLTYP, SLOC_TYPE, VLPLA,
    NLTYP, DLOC_TYPE, NLPLA, VLENR, NLENR,
    MATID, O.MEINS, WHO, QUEUE, EXCCODE, CONFIRMED_BY,
    CREATED_AT, STARTED_AT, CONFIRMED_AT, CONFIRMED_AT_WH,
    NISTM,PSA,TOSTAT, VLBER, NLBER, CREATED_BY, RDOCCAT, M.MATNR
  FROM EWM_S4_NA_PROD_DATASHARE.STAGING."/SCWM/ORDIM_C" O
  LEFT JOIN EWM_S4_NA.PROD_DATASHARE.V_STAGING__MARA  M
    ON O.matid = M.SCM_MATID_GUID16
  WHERE TOSTAT = 'C' AND TRART IN (1,2,3,4)
),
T_TIMES AS (
  SELECT
    R.*,
    SP.TIMEZONE,
    TRY_TO_DATE(LEFT(R.CREATED_AT,8),'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE(LEFT(R.STARTED_AT,8),'YYYYMMDD') AS STARTED_DATE,
    TRY_TO_DATE(LEFT(R.CONFIRMED_AT,8),'YYYYMMDD') AS CONFIRMED_DATE,
    CAST(CONVERT_TIMEZONE('UTC', SP.TIMEZONE, TRY_TO_TIMESTAMP(TO_VARCHAR(R.CONFIRMED_AT),'YYYYMMDDHH24MISS')) AS DATE) AS CONFIRMED_LOCAL_DATE,
    TRY_TO_DATE(LEFT(R.CONFIRMED_AT_WH,8),'YYYYMMDD') AS CONFIRMED_DATE_WH,
    TRY_TO_TIMESTAMP(TO_VARCHAR(R.CONFIRMED_AT_WH),'YYYYMMDDHH24MISS') AS CONFIRMED_AT_TS,
    CONVERT_TIMEZONE('UTC', SP.TIMEZONE,
      TRY_TO_TIMESTAMP(TO_VARCHAR(R.STARTED_AT),'YYYYMMDDHH24MISS')
    ) AS STARTED_AT_TS,
    CURRENT_TIMESTAMP()::TIMESTAMP_NTZ AS CC_UPDATED_DATETIMESTAMP,
    SUM(R.NISTM) OVER (PARTITION BY R.TANUM, R.TAPOS) AS ACTUAL_QUANTITY
  FROM BASE R
  JOIN (SELECT DISTINCT LGNUM, SRC_SYS, TIMEZONE FROM SHIFT_BASE) SP
    ON SP.LGNUM = R.LGNUM AND SP.SRC_SYS = R.CC_SOURCE_SYSTEM
),
OFFSETS AS (SELECT -1 AS off UNION ALL SELECT 0 UNION ALL SELECT 1),
SHIFT_CHOICES AS (
  SELECT
    T.*,
    P.SHIFT_TYPE,
    P.SHIFT_START_RAW,
    TO_TIMESTAMP_NTZ(
      TO_CHAR(DATEADD(DAY, O.off, T.CONFIRMED_LOCAL_DATE), 'YYYY-MM-DD') || ' ' || P.SHIFT_START_RAW,
      'YYYY-MM-DD HH24:MI'
    ) AS SHIFT_START_TS_CAND,
    ABS(DATEDIFF('minute', T.CONFIRMED_AT_TS, TO_TIMESTAMP_NTZ(
      TO_CHAR(DATEADD(DAY, O.off, T.CONFIRMED_LOCAL_DATE), 'YYYY-MM-DD') || ' ' || P.SHIFT_START_RAW,
      'YYYY-MM-DD HH24:MI'
    ))) AS SHIFT_DIFF_MIN
  FROM T_TIMES T
  JOIN SHIFT_PARAMS P
    ON P.LGNUM = T.LGNUM AND P.SRC_SYS = T.CC_SOURCE_SYSTEM
  JOIN OFFSETS O ON TRUE
),
PICKED_SHIFT AS (
  SELECT *
  FROM (
    SELECT
      S.*,
      ROW_NUMBER() OVER (PARTITION BY S.LGNUM, S.TANUM, S.TAPOS ORDER BY S.SHIFT_DIFF_MIN ASC) AS RN
    FROM SHIFT_CHOICES S
  )
  WHERE RN = 1
),
SESSIONIZE AS (
  SELECT
    P.*,
    LAG(P.CONFIRMED_AT_TS) OVER (
      PARTITION BY P.LGNUM, P.CONFIRMED_BY
      ORDER BY P.CONFIRMED_AT_TS, P.TANUM, P.TAPOS
    ) AS PREV_CONFIRMED_AT_TS,
    ROW_NUMBER() OVER (
      PARTITION BY P.LGNUM, P.CONFIRMED_BY
      ORDER BY P.CONFIRMED_AT_TS, P.TANUM, P.TAPOS
    ) AS OPERATOR_ROW_NUM
  FROM PICKED_SHIFT P
),
SESSIONIZED AS (
  SELECT
    S.*,
    DATEDIFF('minute', S.PREV_CONFIRMED_AT_TS, S.CONFIRMED_AT_TS) AS GAP_MINUTES,
    IFF(
      S.PREV_CONFIRMED_AT_TS IS NULL OR DATEDIFF('minute', S.PREV_CONFIRMED_AT_TS, S.CONFIRMED_AT_TS) > 240,
      1, 0
    ) AS IS_NEW_SESSION
  FROM SESSIONIZE S
),
SESSION_IDS AS (
  SELECT
    X.*,
    SUM(IS_NEW_SESSION) OVER (
      PARTITION BY X.LGNUM, X.CONFIRMED_BY
      ORDER BY X.CONFIRMED_AT_TS, X.TANUM, X.TAPOS
      ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS SESSION_SEQ
  FROM SESSIONIZED X
),
SESSION_ENRICH AS (
  SELECT
    S.*,
    FIRST_VALUE(S.SHIFT_START_TS_CAND) OVER (
      PARTITION BY S.LGNUM, S.CONFIRMED_BY, S.SESSION_SEQ
      ORDER BY S.CONFIRMED_AT_TS, S.TANUM, S.TAPOS
      ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS SESSION_FIRST_SHIFT_START_TS,
    FIRST_VALUE(S.CONFIRMED_AT_TS) OVER (
      PARTITION BY S.LGNUM, S.CONFIRMED_BY, S.SESSION_SEQ
      ORDER BY S.CONFIRMED_AT_TS, S.TANUM, S.TAPOS
      ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS SESSION_FIRST_CONFIRMED_AT_TS,
    ROW_NUMBER() OVER (
      PARTITION BY S.LGNUM, S.CONFIRMED_BY, S.SESSION_SEQ
      ORDER BY S.CONFIRMED_AT_TS, S.TANUM, S.TAPOS
    ) AS SESSION_ROW_NUM
  FROM SESSION_IDS S
),
FINAL AS (
  SELECT
    HASH(F.LGNUM,F.TANUM,F.TAPOS,'EWM_S4_NA') AS WAREHOUSE_TASK_KEY, 
    F.LGNUM AS WAREHOUSE_ID,
    F.TANUM AS WAREHOUSE_TASK,
    F.TAPOS AS WAREHOUSE_TASK_ITEM,
    F.PROCTY AS PROCESS_TYPE,
    F.TRART AS PROCESS_CATEGORY,
    F.DOCCAT AS DOCUMENT_CATEGORY,
    F.RDOCCAT AS REFERENCE_DOCUMENT_CATEGORY,
    F.PSA AS PRODUCTION_SUPPLY_AREA,
    F.REASON AS MOVEMENT_REASON,
    CASE
      WHEN F.PROCTY = '3030' THEN 'REPLENISHMENT'
      WHEN F.PROCTY LIKE '1%' THEN 'INBOUND'
      WHEN F.PROCTY LIKE '2%' THEN 'OUTBOUND' 
      WHEN F.TRART = '4' THEN 'INVENTORY'
      ELSE 'INTERNAL'
    END AS DIRECTION,
    F.GUID_STOCK AS STOCK_ITEM,
    F.LETYP AS HANDLING_UNIT_TYPE,
    F.VLENR AS SOURCE_HANDLING_UNIT,
    F.VLBER AS SOURCE_STORAGE_SECTION,
    F.VLTYP AS SOURCE_STORAGE_TYPE,
    F.SLOC_TYPE AS SOURCE_LOCATION_TYPE,
    F.VLPLA AS SOURCE_STORAGE_BIN,
    F.NLENR AS DEST_HANDLING_UNIT,
    F.NLBER AS DESTINATION_STORAGE_SECTION,
    F.NLTYP AS DEST_STORAGE_TYPE,
    F.DLOC_TYPE AS DEST_LOCATION_TYPE,
    F.NLPLA AS DEST_STORAGE_BIN,
    F.MATID AS PRODUCT_ID,
    F.MATNR AS MATERIAL_NUMBER,
    F.MEINS AS BASE_UOM,
    F.WHO AS WAREHOUSE_ORDER,
    F.QUEUE,
    F.EXCCODE AS EXCEPTION_CODE,
    F.CONFIRMED_BY AS OPERATOR,
    F.CREATED_DATE,
    F.CREATED_AT AS CREATED_TIMESTAMP,
    F.STARTED_DATE,
    F.STARTED_AT AS STARTED_TIMESTAMP,
    F.CONFIRMED_DATE,
    F.CONFIRMED_AT AS CONFIRMED_TIMESTAMP,
    F.CONFIRMED_AT_WH AS CONFIRMED_WH_TIMESTAMP,
    F.CONFIRMED_DATE_WH AS CONFIRMED_WH_DATE,
    F.STARTED_AT_TS AS STARTED_WH_TIMESTAMP,
    F.NISTM AS ACTUAL_QUANTITY,

    CASE
      WHEN F.SESSION_ROW_NUM = 1 THEN
        CASE
          WHEN F.SHIFT_START_TS_CAND IS NOT NULL
           AND DATE_PART('HOUR', F.CONFIRMED_AT_TS) = DATE_PART('HOUR', F.SHIFT_START_TS_CAND) AND DATE_PART('MINUTE', F.CONFIRMED_AT_TS) >= DATE_PART('MINUTE', F.SHIFT_START_TS_CAND)
          THEN ABS(DATEDIFF('SECOND', F.SHIFT_START_TS_CAND, F.CONFIRMED_AT_TS))
          WHEN DATE_PART('MINUTE', F.CONFIRMED_AT_TS) < 30
          THEN DATEDIFF('SECOND', DATE_TRUNC('HOUR', F.CONFIRMED_AT_TS), F.CONFIRMED_AT_TS)
          ELSE DATEDIFF('SECOND', DATEADD('MINUTE', 30, DATE_TRUNC('HOUR', F.CONFIRMED_AT_TS)), F.CONFIRMED_AT_TS)
        END
      ELSE
        IFF(F.PREV_CONFIRMED_AT_TS IS NOT NULL,
            DATEDIFF('SECOND', F.PREV_CONFIRMED_AT_TS, F.CONFIRMED_AT_TS),
            0)
    END AS TIME_TAKEN_IN_SEC,

    DATEDIFF(SECOND, F.STARTED_AT_TS, F.CONFIRMED_AT_TS) AS TIME_TAKEN_WH_TASK_IN_SEC,

    IFF(
      F.SESSION_ROW_NUM = 1,
      DATEDIFF(SECOND, F.SHIFT_START_TS_CAND, F.STARTED_AT_TS),
      DATEDIFF(SECOND, F.PREV_CONFIRMED_AT_TS, F.STARTED_AT_TS)
    ) AS WAITING_MOVING_TIME_IN_SEC,

    IFF(
      TIME_TAKEN_IN_SEC <= COALESCE(IP.MAX_TASK_DURATION * 60, 0),
      0,
      TIME_TAKEN_IN_SEC - COALESCE(IP.MAX_TASK_DURATION * 60, 0)
    ) AS INDIRECT_TIME_IN_SEC,

    IFF(
      F.VLPLA = F.NLPLA,
      0,
      IFF(IFNULL(F.SLOC_TYPE,'0') = 'R' OR IFNULL(F.DLOC_TYPE,'0') = 'R', 0.5, 1)
    ) AS HANDLING_UNIT_COUNT,

    F.IS_NEW_SESSION,
    F.SESSION_SEQ,
    F.SHIFT_START_TS_CAND AS SHIFT_START_TS,
    TO_DATE(F.SHIFT_START_TS_CAND) AS SHIFT_DATE,
    DATEADD('HOUR', 12, F.SHIFT_START_TS_CAND) AS SHIFT_END_TS,
    F.LGNUM || '-' || F.CONFIRMED_BY || '-' ||
      TO_CHAR(F.SESSION_FIRST_CONFIRMED_AT_TS, 'YYYY-MM-DD\"T\"HH24:MI') || '-' ||
      LPAD(F.SESSION_SEQ::STRING, 4, '0') AS SHIFT_SESSION_ID,
    F.OPERATOR_ROW_NUM AS OPERATOR_TASK_RANK,

    -- KPI: Override (windowed over warehouse/operator/confirmed_wh_date)
    COUNT(*) OVER (
      PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
    ) AS TOTAL_WH_TASK,
    COUNT_IF(NVL(F.EXCCODE,'') <> '') OVER (
      PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
    ) AS TOTAL_OVERRIDE,
    ROUND(
      (COUNT_IF(NVL(F.EXCCODE,'') <> '') OVER (
        PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
      ) * 100.0)
      / NULLIF(
          COUNT(*) OVER (PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH),
          0
        ),
      2
    ) AS PCT_OVERRIDE,

    -- KPI: MRR usage (filtered by NLTYP mapping as in your aggregate query)
    COUNT_IF(NP.NLTYP IS NOT NULL AND F.PROCTY = '3030') OVER (
      PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
    ) AS MRR_COUNT,
    COUNT_IF(NP.NLTYP IS NOT NULL AND F.PROCTY <> '3030') OVER (
      PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
    ) AS NONMRR_COUNT,
    ROUND(
      (COUNT_IF(NP.NLTYP IS NOT NULL AND F.PROCTY <> '3030') OVER (
        PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
      ) * 100.0)
      / NULLIF(
          COUNT_IF(NP.NLTYP IS NOT NULL AND F.PROCTY = '3030') OVER (
            PARTITION BY F.LGNUM, F.CONFIRMED_BY, F.CONFIRMED_DATE_WH
          ),
          0
        ),
      2
    ) AS PCT_NONMRR_USAGE,

    'EWM_S4_NA' AS CC_SOURCE_SYSTEM,
    CURRENT_TIMESTAMP() AS CC_CREATED_DATETIMESTAMP,
    CURRENT_TIMESTAMP() AS CC_UPDATED_DATETIMESTAMP,
    'UTC' AS CC_TIMEZONE

  FROM SESSION_ENRICH F
  LEFT JOIN INDIRECT_PARAMS IP
    ON F.LGNUM = IP.LGNUM AND 'NA' = IP.SRC_SYS
  LEFT JOIN NLTYP_PARAMS NP
    ON NP.LGNUM = F.LGNUM AND NP.NLTYP = F.NLTYP AND NP.SRC_SYS = 'NA'
)

SELECT *
FROM FINAL
WHERE LEFT(CREATED_TIMESTAMP,8) >= IFNULL(
  (
    SELECT DATEADD(MONTH, -4, CONVERT_TIMEZONE('UTC', LAST_SUCCESSFUL_LOAD_DATETIME)) AS LAST_SUCCESSFUL_LOAD_DATETIME
    FROM UCMF.UTILITIES.DATA_LOAD_CONFIG_V2  
    WHERE SOURCE_KEY = (
      SELECT SOURCE_KEY FROM UCMF.UTILITIES.DATA_SOURCE_V2 WHERE SOURCE_NAME='EWM_S4'
    )
    AND TARGET_TABLE_ID = (
      SELECT TABLE_ID FROM UCMF.UTILITIES.SOURCE_TABLE_VIEW_V2 WHERE TABLE_NAME='T_TD_GBL_SC_WMS_WAREHOUSE_TASK'
    )
    AND SOURCE_TABLE_ID = (
      SELECT TABLE_ID FROM UCMF.UTILITIES.SOURCE_TABLE_VIEW_V2 WHERE TABLE_NAME=' V_TD_GBL_SC_WMS_WAREHOUSE_TASK'
    )
  ),
  '1901-01-01'
)
ORDER BY CONFIRMED_WH_TIMESTAMP, WAREHOUSE_TASK, WAREHOUSE_TASK_ITEM
);
