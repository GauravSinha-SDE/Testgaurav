
WITH SHIFT_PARAMS AS (
  SELECT 
    PA_FROM AS LGNUM,
    SRC_SYS,
    PA_TO AS SHIFT_START_RAW,
    ZCOMMENT AS TIMEZONE,
    CASE 
      WHEN TO_TIME(PA_TO) BETWEEN TO_TIME('05:00') AND TO_TIME('12:00') THEN 'DAY'
      WHEN TO_TIME(PA_TO) BETWEEN TO_TIME('17:00') AND TO_TIME('23:59') THEN 'NIGHT'
      ELSE 'UNKNOWN'
    END AS SHIFT_TYPE
  FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
  WHERE PROCESS = 'WMS' AND CATE = 'SHIFT_HR'
),
INDIRECT_PARAMS AS (
  SELECT PA_FROM AS LGNUM, SRC_SYS, PA_TO::INT AS MAX_TASK_DURATION
  FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
  WHERE PROCESS = 'WMS' AND CATE = 'IND_TIME'
),
TIMEZONE_PARAMS AS (
  SELECT PA_FROM AS LGNUM, SRC_SYS, ZCOMMENT
  FROM SC_MD.INT_SC_MD.T_SC_PARAMETERS
  WHERE PROCESS = 'WMS' AND CATE = 'SHIFT_HR'
),
BASE AS (
  SELECT 
    'NA' AS CC_SOURCE_SYSTEM,
    LGNUM, TANUM, PROCTY, TRART, DOCCAT, REASON,
    GUID_STOCK, LETYP, VLTYP, SLOC_TYPE, VLPLA,
    NLTYP, DLOC_TYPE, NLPLA, VLENR, NLENR,
    MATID, MEINS, WHO, QUEUE, EXCCODE, CONFIRMED_BY,
    CREATED_AT, STARTED_AT, CONFIRMED_AT, CONFIRMED_AT_WH,
    NISTM
  FROM EWM_S4_NA_PROD_DATASHARE.STAGING."/SCWM/ORDIM_C"
  WHERE TOSTAT = 'C' AND TRART IN (1,2,3,4)
),
TRANSFORMED AS (
  SELECT
    R.*,
    TZ.ZCOMMENT,
    CASE
      WHEN R.PROCTY = '3030' THEN 'REPLENISHMENT'
      WHEN R.PROCTY LIKE '1%' THEN 'INBOUND'
      WHEN R.PROCTY LIKE '2%' THEN 'OUTBOUND'
      ELSE 'OTHERS'
    END AS DIRECTION,
    TRY_TO_DATE(LEFT(R.CREATED_AT,8),'YYYYMMDD') AS CREATED_DATE,
    TRY_TO_DATE(LEFT(R.STARTED_AT,8),'YYYYMMDD') AS STARTED_DATE,
    TRY_TO_DATE(LEFT(R.CONFIRMED_AT,8),'YYYYMMDD') AS CONFIRMED_DATE,
    TRY_TO_DATE(LEFT(R.CONFIRMED_AT_WH,8),'YYYYMMDD') AS CONFIRMED_DATE_WH,
    TRY_TO_TIMESTAMP(TO_VARCHAR(R.CONFIRMED_AT_WH),'YYYYMMDDHH24MISS') AS CONFIRMED_AT_TS,
    CONVERT_TIMEZONE('UTC', TZ.ZCOMMENT,
      TRY_TO_TIMESTAMP(TO_VARCHAR(R.STARTED_AT),'YYYYMMDDHH24MISS')
    ) AS STARTED_AT_TS,
    CURRENT_TIMESTAMP()::TIMESTAMP_NTZ AS CC_UPDATED_DATETIMESTAMP,
    SUM(R.NISTM) OVER (PARTITION BY R.TANUM) AS ACTUAL_QUANTITY
  FROM BASE R
  JOIN TIMEZONE_PARAMS TZ
    ON R.LGNUM = TZ.LGNUM AND R.CC_SOURCE_SYSTEM = TZ.SRC_SYS
),
SHIFT_CANDIDATES AS (
  SELECT 
    T.*, 
    S.SHIFT_START_RAW,
    S.SHIFT_TYPE,
    TO_TIMESTAMP(
      TO_CHAR(DATEADD(DAY, d.offset, T.CONFIRMED_DATE_WH), 'YYYY-MM-DD') || ' ' || S.SHIFT_START_RAW,
      'YYYY-MM-DD HH24:MI'
    ) AS SHIFT_START_TS,
    DATEADD(HOUR, 12,
      TO_TIMESTAMP(
        TO_CHAR(DATEADD(DAY, d.offset, T.CONFIRMED_DATE_WH), 'YYYY-MM-DD') || ' ' || S.SHIFT_START_RAW,
        'YYYY-MM-DD HH24:MI'
      )
    ) AS SHIFT_END_TS,
    ABS(DATEDIFF(MINUTE, T.CONFIRMED_AT_TS,
      TO_TIMESTAMP(
        TO_CHAR(DATEADD(DAY, d.offset, T.CONFIRMED_DATE_WH), 'YYYY-MM-DD') || ' ' || S.SHIFT_START_RAW,
        'YYYY-MM-DD HH24:MI'
      )
    )) AS SHIFT_DIFF_MIN
  FROM TRANSFORMED T
  JOIN SHIFT_PARAMS S
    ON T.LGNUM = S.LGNUM AND T.CC_SOURCE_SYSTEM = S.SRC_SYS
  CROSS JOIN (
    SELECT -1 AS offset UNION ALL SELECT 0 UNION ALL SELECT 1
  ) d
),
CLOSEST_SHIFT AS (
  SELECT *
  FROM (
    SELECT *,
      CASE 
        WHEN CONFIRMED_AT_TS BETWEEN DATEADD(MINUTE,-60,SHIFT_START_TS) AND SHIFT_END_TS THEN 1
        WHEN CONFIRMED_AT_TS BETWEEN SHIFT_START_TS AND SHIFT_END_TS THEN 2
        ELSE 3
      END AS PRIORITY,
      ROW_NUMBER() OVER (
        PARTITION BY LGNUM, TANUM, CONFIRMED_AT_TS
        ORDER BY 
          CASE 
            WHEN CONFIRMED_AT_TS BETWEEN DATEADD(MINUTE,-60,SHIFT_START_TS) AND SHIFT_END_TS THEN 1
            WHEN CONFIRMED_AT_TS BETWEEN SHIFT_START_TS AND SHIFT_END_TS THEN 2
            ELSE 3
          END,
          SHIFT_DIFF_MIN,
          SHIFT_START_TS
      ) AS RN
    FROM SHIFT_CANDIDATES
  ) AS ranked
  WHERE RN = 1
),
SHIFT_ENRICHED AS (
  SELECT *,
    SHIFT_START_TS AS FINAL_SHIFT_START_TS,
    CONCAT(LGNUM, '-', CONFIRMED_BY, '-', TO_CHAR(SHIFT_START_TS, 'YYYY-MM-DD"T"HH24:MI')) AS SHIFT_SESSION_ID,
    CASE 
      WHEN CONFIRMED_AT_TS < SHIFT_START_TS THEN 'EARLY'
      WHEN CONFIRMED_AT_TS BETWEEN SHIFT_START_TS AND SHIFT_END_TS THEN 'ON_TIME'
      ELSE 'LATE'
    END AS SHIFT_ALIGNMENT
  FROM CLOSEST_SHIFT
),
RANKED AS (
  SELECT *,
    ROW_NUMBER() OVER (
      PARTITION BY LGNUM, CONFIRMED_BY, FINAL_SHIFT_START_TS
      ORDER BY CONFIRMED_AT_TS, TANUM
    ) AS OPERATOR_TASK_RANK,
    LAG(CONFIRMED_AT_TS) OVER (
      PARTITION BY LGNUM, CONFIRMED_BY, FINAL_SHIFT_START_TS
      ORDER BY CONFIRMED_AT_TS, TANUM
    ) AS PREV_CONFIRMED_TS_IN_SHIFT
  FROM SHIFT_ENRICHED
),
FINAL AS (
  SELECT
    R.*,
    IP.MAX_TASK_DURATION,
    DATEDIFF(SECOND, STARTED_AT_TS, CONFIRMED_AT_TS) AS TIME_TAKEN_WH_TASK_IN_SEC,
    IFF(
      OPERATOR_TASK_RANK = 1,
      DATEDIFF(SECOND, SHIFT_START_TS, STARTED_AT_TS),
      DATEDIFF(SECOND, PREV_CONFIRMED_TS_IN_SHIFT, STARTED_AT_TS)
    ) AS WAITING_MOVING_TIME_IN_SEC,
    CASE
      WHEN OPERATOR_TASK_RANK = 1 THEN
        DATEDIFF(
          SECOND,
          CASE
            WHEN SHIFT_START_TS IS NOT NULL AND SHIFT_ALIGNMENT != 'EARLY' THEN SHIFT_START_TS
            WHEN DATE_PART(MINUTE, CONFIRMED_AT_TS) < 30 THEN DATE_TRUNC('HOUR', CONFIRMED_AT_TS)
            ELSE DATEADD(MINUTE, 30, DATE_TRUNC('HOUR', CONFIRMED_AT_TS))
          END,
          CONFIRMED_AT_TS
        )
      ELSE DATEDIFF(SECOND, PREV_CONFIRMED_TS_IN_SHIFT, CONFIRMED_AT_TS)
    END AS TIME_TAKEN_IN_SEC,
    IFF(
      TIME_TAKEN_IN_SEC <= COALESCE(MAX_TASK_DURATION * 60, 0),
      0,
      TIME_TAKEN_IN_SEC - COALESCE(MAX_TASK_DURATION * 60, 0)
    ) AS INDIRECT_TIME_IN_SEC
  FROM RANKED R
  LEFT JOIN INDIRECT_PARAMS IP
    ON R.LGNUM = IP.LGNUM AND R.CC_SOURCE_SYSTEM = IP.SRC_SYS
)
SELECT
  LGNUM AS WAREHOUSE_NUMBER,
  TANUM AS WAREHOUSE_TASK,
  PROCTY AS PROCESS_TYPE,
  TRART AS PROCESS_CATEGORY,
  DOCCAT AS DOCUMENT_CATEGORY,
  REASON AS MOVEMENT_REASON,
  DIRECTION,
  GUID_STOCK AS GUID_STOCK_ITEM,
  LETYP AS HANDLING_UNIT_TYPE,
  VLTYP AS SOURCE_STORAGE_TYPE,
  SLOC_TYPE AS LOCATION_TYPE,
  VLPLA AS SOURCE_STORAGE_BIN,
  NLTYP AS DEST_STORAGE_TYPE,
  DLOC_TYPE AS DEST_LOCATION_TYPE,
  NLPLA AS DEST_STORAGE_BIN,
  VLENR AS SOURCE_HU,
  NLENR AS DEST_HU,
  MATID AS PRODUCT_ID,
  MEINS AS BASE_UOM,
  WHO AS WAREHOUSE_ORDER,
  QUEUE,
  EXCCODE AS EXCEPTION_CODE,
  CONFIRMED_BY,
    CREATED_AT AS CREATED_TIMESTAMP,
  FINAL_SHIFT_START_TS,
  SHIFT_START_TS,
  OPERATOR_TASK_RANK,
  PRIORITY,
  SHIFT_ALIGNMENT,
  SHIFT_SESSION_ID,
  SHIFT_END_TS,
  STARTED_AT AS STARTED_TIMESTAMP,
  CONFIRMED_AT AS CONFIRMED_TIMESTAMP,
  CONFIRMED_AT_WH AS CONFIRMED_WH_TIMESTAMP,
  CONFIRMED_DATE_WH,
  ACTUAL_QUANTITY,
  CREATED_DATE,
  STARTED_DATE,
  CONFIRMED_DATE,
  TIME_TAKEN_IN_SEC,
  TIME_TAKEN_WH_TASK_IN_SEC,
  WAITING_MOVING_TIME_IN_SEC,
  INDIRECT_TIME_IN_SEC,
  IFF(
    SOURCE_STORAGE_BIN = DEST_STORAGE_BIN, 
    0,
    IFF(
      LOCATION_TYPE = 'R' OR DEST_LOCATION_TYPE = 'R',
      0.5,
      1
    )
  ) AS HU_COUNT,
  CC_SOURCE_SYSTEM,
  CC_UPDATED_DATETIMESTAMP
FROM FINAL
WHERE 
  CONFIRMED_BY = 'C20976'
  AND CONFIRMED_DATE_WH >= '2025-08-01' 
  AND CONFIRMED_DATE_WH <= '2025-08-31'
ORDER BY CONFIRMED_TIMESTAMP, WAREHOUSE_TASK;
