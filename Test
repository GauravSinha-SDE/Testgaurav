SELECT
  LGNUM AS WAREHOUSE_NUMBER,
  TANUM AS WAREHOUSE_TASK,
  PROCTY AS PROCESS_TYPE,
  TRART AS PROCESS_CATEGORY,
  DOCCAT AS DOCUMENT_CATEGORY,
  REASON AS MOVEMENT_REASON,
  DIRECTION,
  GUID_STOCK AS GUID_STOCK_ITEM,
  LETYP AS HANDLING_UNIT_TYPE,
  VLTYP AS SOURCE_STORAGE_TYPE,
  SLOC_TYPE AS LOCATION_TYPE,
  VLPLA AS SOURCE_STORAGE_BIN,
  NLTYP AS DEST_STORAGE_TYPE,
  DLOC_TYPE AS DEST_LOCATION_TYPE,
  NLPLA AS DEST_STORAGE_BIN,
  VLENR AS SOURCE_HU,
  NLENR AS DEST_HU,
  MATID AS PRODUCT_ID,
  MEINS AS BASE_UOM,
  WHO AS WAREHOUSE_ORDER,
  QUEUE,
  EXCCODE AS EXCEPTION_CODE,
  CONFIRMED_BY,

  /* Timestamps (formatted) */
  TO_CHAR(CREATED_AT_TS,   'YYYY-MM-DD HH24:MI:SS') AS CREATED_TIMESTAMP,
  TO_CHAR(FINAL_SHIFT_START_TS, 'YYYY-MM-DD HH24:MI:SS') AS FINAL_SHIFT_START_TS,
  TO_CHAR(FINAL_SHIFT_START_TS, 'YYYY-MM-DD HH24:MI:SS') AS SHIFT_START_TS,
  TO_CHAR(SHIFT_END_TS, 'YYYY-MM-DD HH24:MI:SS') AS SHIFT_END_TS,
  TO_CHAR(STARTED_AT_TS,  'YYYY-MM-DD HH24:MI:SS') AS STARTED_TIMESTAMP,
  TO_CHAR(CONFIRMED_AT_SRC_TS, 'YYYY-MM-DD HH24:MI:SS') AS CONFIRMED_TIMESTAMP,
  TO_CHAR(CONFIRMED_AT_TS, 'YYYY-MM-DD HH24:MI:SS') AS CONFIRMED_WH_TIMESTAMP,

  /* Shift/meta fields restored */
  OPERATOR_TASK_RANK,
  PRIORITY,
  SHIFT_ALIGNMENT,
  SHIFT_SESSION_ID,

  /* Dates and quantities */
  CONFIRMED_DATE_WH,
  ACTUAL_QUANTITY,
  CREATED_DATE_UTC AS CREATED_DATE,
  STARTED_DATE_UTC AS STARTED_DATE,
  CONFIRMED_DATE_UTC AS CONFIRMED_DATE,

  /* Metrics */
  TIME_TAKEN_IN_SEC,
  TIME_TAKEN_WH_TASK_IN_SEC,
  WAITING_MOVING_TIME_IN_SEC,
  INDIRECT_TIME_IN_SEC,

  /* HU count */
  IFF(
    VLPLA = NLPLA, 
    0,
    IFF(
      SLOC_TYPE = 'R' OR DLOC_TYPE = 'R',
      0.5,
      1
    )
  ) AS HU_COUNT,

  CC_SOURCE_SYSTEM,
  TO_CHAR(CC_UPDATED_DATETIMESTAMP, 'YYYY-MM-DD HH24:MI:SS') AS CC_UPDATED_DATETIMESTAMP
FROM FINAL
WHERE 
  CONFIRMED_BY = 'C20976'
  AND CONFIRMED_DATE_WH >= DATE('2025-08-01') 
  AND CONFIRMED_DATE_WH <= DATE('2025-08-31')
ORDER BY CONFIRMED_AT_TS, WAREHOUSE_TASK;
